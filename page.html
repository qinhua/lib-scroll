<html>
<head>
	<meta charset="utf-8">
	<title>手机淘宝 淘我喜欢</title>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
	<meta content="yes" name="apple-mobile-web-app-capable">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="index.css">
    <style>
    html, body, #wrap, #tbh5v0, #bodyCont {
        padding: 0;
        margin: 0;
        height: 100%;
        overflow: hidden;
        background: #FFF;
    }

    .search-list > ul {
        min-height: 0;
    }

    .search-content {
        position: relative;
    }

    .page {
        width: 100%;
        position: absolute;
        overflow: hidden;
    }

    .page-nav {
        display: block;
        height: 30px;
        line-height: 30px;
        text-align: center;
        font-size: 14px;
        background: #FFF;
    }

    </style>
</head>
<body scroll="none">
<div id="wrap">
    <div id="tbh5v0" class="mytaobao">
        <div id="bodyCont" class="screen-wrap fullscreen searchlist">
            <div class="search-content">
                <div class="search-list list-view page">
                    <ul class="page-scroll"></ul>
                </div>
                <div class="search-list list-view page">
                    <ul class="page-scroll"></ul>
                </div>
                <div class="search-list list-view page">
                    <ul class="page-scroll"></ul>
                </div>
                <div class="search-list list-view page">
                    <ul class="page-scroll"></ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/template" id="itemTpl">
    <li>
        <div class="list-item">
            <div class="p">
                <a href="http://mclick.simba.taobao.com/cc_im?p=iphone5s&amp;s=384300457&amp;k=269&amp;e=Bf52Czfzg4zEzEYXHF1ZrjhZAekQJJP1K4M14jql2z%2F1lYR6JgolkyoCZbepooNsYHcE2byB58uPEB5nyzmdRlFplfhdyusoNBrETXawvQ6BF7KUbKK962nsBJEbCRNEQA7w4cN%2F10pIouaYhvJponIUuKyCq5k8UWTc1rhquXcHnpuCFIjDVpsXMwjxx%2BxkzeiRu%2Bi0WaRELmURVnaN47Cr9H8IhjN4YT2aULWczh7FPRTaiMoo3quVwCSMOmdelXji%2B%2BqulpI%3D" title=""><img class="p-pic lazy" data-src="http://gma.alicdn.com/tfscom/i2/11031028964676638/T1WMPDFlVbXXXXXXXX_!!0-item_pic.jpg_210x210.jpg" style="visibility: visible;"></a>
            </div>
            <div class="d">
                <a href="http://mclick.simba.taobao.com/cc_im?p=iphone5s&amp;s=384300457&amp;k=269&amp;e=Bf52Czfzg4zEzEYXHF1ZrjhZAekQJJP1K4M14jql2z%2F1lYR6JgolkyoCZbepooNsYHcE2byB58uPEB5nyzmdRlFplfhdyusoNBrETXawvQ6BF7KUbKK962nsBJEbCRNEQA7w4cN%2F10pIouaYhvJponIUuKyCq5k8UWTc1rhquXcHnpuCFIjDVpsXMwjxx%2BxkzeiRu%2Bi0WaRELmURVnaN47Cr9H8IhjN4YT2aULWczh7FPRTaiMoo3quVwCSMOmdelXji%2B%2BqulpI%3D" title="">
                    <h3 class="d-title"> iPhone 5s 香港商家 原封未激活 百分百原装</h3>
                </a>
                <p class="d-price">
                    <em class="h">￥4198</em><del>￥4498</del>
                </p>
                <div class="d-main">
                    <p class="d-freight">免运费</p>
                    <p class="d-num">828人购买</p>
                    <p class="d-area">香港</p>
                </div>
            </div>
        </div>
    </li>
</script>
<script src="build/combo.debug.js" type="text/javascript"></script>
<script src="build/scroll.debug.js" type="text/javascript"></script>
<script src="build/plugin.debug.js" type="text/javascript"></script>
<script>
var tpl = document.getElementById('itemTpl').innerHTML;
var content = document.querySelector('.search-content');
var pageUls = document.querySelectorAll('.page-scroll');
var pageHeight = document.documentElement.getBoundingClientRect().height;

document.addEventListener('touchmove', function(e) {
    e.preventDefault();
    return false;
}, false);

lib.scroll.outputDebugLog = true;

function genItems() {
    var html = new Array(6).join(tpl);
    var wrap = document.createElement('div');
    wrap.innerHTML = html;
    var fragment = document.createDocumentFragment();

    while (wrap.children.length) {
        fragment.appendChild(wrap.firstElementChild);
    }

    return fragment;
}

function getTransformOffset(element) {
    var offset = {x: 0, y: 0}; 
    var transform = getComputedStyle(element).webkitTransform;
    var matched;

    if (transform !== 'none') {
        if ((matched = transform.match(/^matrix3d\(\d+, \d+, \d+, \d+, \d+, \d+, \d+, \d+, \d+, \d+, \d+, \d+, ([-\d.]+), ([-\d.]+), [-\d.]+, \d+\)/) ||
                transform.match(/^matrix\(\d+, \d+, \d+, \d+, ([-\d.]+), ([-\d.]+)\)$/))) {
            offset.x = parseInt(matched[1]) || 0;
            offset.y = parseInt(matched[2]) || 0;
        }
    }

    return offset;
}

var has3d = 'WebKitCSSMatrix' in window && 'm11' in new WebKitCSSMatrix();
function getTranslate(x, y) {
    if (has3d) {
        return 'translate3d(' + x + 'px, ' + y + 'px, 0)';
    } else {
        return 'translate(' + x + 'px, ' + y + 'px)';
    }
}

content.style.height = pageUls.length * pageHeight + 'px';

// var wrapScroller = new lib.scroll({
//     height: ,
//     scrollElement: content
// }).init();

var scrollers = [];

Array.prototype.forEach.call(pageUls, function(pageUl, i){
    pageUl.parentNode.style.cssText = 'height:' + pageHeight + 'px;-webkit-transform:translateY(' + pageHeight * i + 'px);';
    
    var pageNav = document.createElement('A');
    pageNav.className = 'page-nav';
    pageNav.innerHTML = '第' + (i + 1) + '/' + pageUls.length + '页';
    pageUl.appendChild(pageNav);

    pageUl.appendChild(genItems());

    var nextA = document.createElement('A');
    nextA.className = 'page-nav';
    nextA.innerHTML = ((i === pageUls.length - 1)?'最后一页了':'上拉看下一页');
    pageUl.appendChild(nextA);

    var pageScroller = new lib.scroll({
        scrollElement: pageUl,
        noBounce: true
    }).init();
    scrollers.push(pageScroller);

    pageScroller.enablePlugin('lazyload');

    var boundaryOffset;
    var direction;
    var transformOffset;
    pageScroller.addEventListener('scrollstart', function(e) {
        direction = '';
        boundaryOffset = 0;
        transformOffset = getTransformOffset(content);
    });

    pageScroller.addEventListener('pullup', function(e){
        direction = 'up';
        boundaryOffset = Math.abs(e.boundaryOffset);
        console.log(transformOffset, boundaryOffset)
        content.style.webkitTransform = getTranslate(transformOffset.x, transformOffset.y - boundaryOffset);
    }, false);

    pageScroller.addEventListener('pulldown', function(e){
        direction = 'down';
        boundaryOffset = Math.abs(e.boundaryOffset);
        console.log(transformOffset, boundaryOffset)
        content.style.webkitTransform = getTranslate(transformOffset.x, transformOffset.y + boundaryOffset);
    }, false);

    pageScroller.addEventListener('scrollend', function(e) {
        var offset;
        var index = i;
        if (direction && boundaryOffset && boundaryOffset > pageHeight / 6) {
            if (direction === 'up' && i < pageUls.length - 1) {
                index = i + 1;
            } else if (direction === 'down' && i > 0) {
                index = i - 1;
            }
        }

        setTimeout(function(){
            content.style.webkitTransition = '-webkit-transform 0.4s ease 0';
            content.style.webkitTransform = 'translateY(-' + pageHeight * index + 'px)';
            content.addEventListener('webkitTransitionEnd', function() {
                content.removeEventListener('webkitTransitionEnd', arguments.callee);
                content.style.webkitTransition = '';
                scrollers[index].checkLazyload();
            }, false);
        }, 10);
    }, false);
});

</script>
</body>
</html>